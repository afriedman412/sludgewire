{% extends "base.html" %}

{% block title %}Admin Config{% endblock %}

{% block head %}
<style>
    .config-section {
        max-width: 600px;
        margin-bottom: 32px;
    }
    .form-row {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
    }
    .form-row input[type="email"] {
        flex: 1;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .form-row button {
        padding: 8px 16px;
        background: #0366d6;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .form-row button:hover {
        background: #0256b9;
    }
    .recipient-row, .job-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }
    .recipient-email, .job-info {
        flex: 1;
    }
    .recipient-status, .job-status {
        font-size: 0.9em;
    }
    .recipient-status.active, .job-status.running {
        color: #28a745;
    }
    .recipient-status.inactive, .job-status.pending {
        color: #999;
    }
    .delete-btn {
        padding: 4px 12px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
    }
    .delete-btn:hover {
        background: #c82333;
    }
    .message {
        padding: 12px;
        margin-bottom: 16px;
        border-radius: 4px;
    }
    .message.success {
        background: #d4edda;
        color: #155724;
    }
    .message.error {
        background: #f8d7da;
        color: #721c24;
    }
    .stat-box {
        display: inline-block;
        padding: 12px 20px;
        background: #f6f8fa;
        border-radius: 6px;
        margin-bottom: 16px;
        margin-right: 12px;
    }
    .stat-label {
        font-size: 0.85em;
        color: #666;
    }
    .stat-value {
        font-size: 1.5em;
        font-weight: bold;
    }
    .cron-status {
        padding: 16px;
        background: #f6f8fa;
        border-radius: 6px;
        margin-bottom: 16px;
    }
    .cron-status.success {
        border-left: 4px solid #28a745;
    }
    .cron-status.running {
        border-left: 4px solid #ffc107;
    }
    .cron-status.crashed, .cron-status.completed_with_errors {
        border-left: 4px solid #dc3545;
    }
    .cron-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    .cron-badge {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.85em;
        font-weight: bold;
    }
    .cron-badge.success {
        background: #d4edda;
        color: #155724;
    }
    .cron-badge.running {
        background: #fff3cd;
        color: #856404;
    }
    .cron-badge.crashed, .cron-badge.completed_with_errors {
        background: #f8d7da;
        color: #721c24;
    }
    .cron-details {
        font-size: 0.9em;
        color: #666;
    }
    .cron-details dt {
        font-weight: bold;
        margin-top: 8px;
    }
    .cron-details dd {
        margin-left: 0;
    }
    .cron-error {
        background: #f8d7da;
        color: #721c24;
        padding: 8px;
        border-radius: 4px;
        margin-top: 8px;
        font-family: monospace;
        font-size: 0.85em;
    }
</style>
{% endblock %}

{% block content %}
{% if message %}
<div class="message {{ message_type }}">{{ message }}</div>
{% endif %}

<h2>System Status</h2>
<div class="config-section">
    <div class="stat-box">
        <div class="stat-label">Memory Usage</div>
        <div class="stat-value">{{ "%.1f"|format(memory_mb) }} MB</div>
    </div>
</div>

<h2>Ingestion Settings</h2>
<div class="config-section">
    <form method="POST" action="/config/settings/email_enabled">
        <div class="form-row">
            <label style="flex: 0 0 auto; padding: 8px 0; display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" name="enabled" value="true" {% if email_enabled %}checked{% endif %} style="width: 18px; height: 18px;" />
                Email alerts enabled
            </label>
            <button type="submit">Update</button>
        </div>
    </form>

    <form method="POST" action="/config/settings/max_new_per_run" style="margin-top: 16px;">
        <div class="form-row">
            <label for="max_new_per_run" style="flex: 0 0 auto; padding: 8px 0;">Max filings per run:</label>
            <input type="number" name="value" id="max_new_per_run" value="{{ max_new_per_run }}" min="1" max="500" style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
            <button type="submit">Update</button>
        </div>
        <p class="muted" style="font-size: 0.85em; margin-top: 8px;">
            Limits how many new filings are processed per cron run to avoid memory issues. (1-500)
        </p>
    </form>
</div>

<h2>Schedule A Tracking</h2>
<div class="config-section">
    <form method="POST" action="/config/settings/sa_target_committee_ids">
        <div class="form-row">
            <label for="sa_target_committee_ids" style="flex: 0 0 auto; padding: 8px 0;">
                Target PAC Committee IDs:
            </label>
        </div>
        <div class="form-row">
            <textarea name="committee_ids" id="sa_target_committee_ids"
                rows="4"
                style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 0.85em;"
                placeholder="C00813006, C00401224, ...">{{ sa_target_committee_ids | join(', ') }}</textarea>
            <button type="submit">Update</button>
        </div>
        <p class="muted" style="font-size: 0.85em; margin-top: 8px;">
            Comma-separated FEC committee IDs. Schedule A items will only be parsed from F3X filings by these committees.
            Currently tracking {{ sa_target_committee_ids | length }} committee(s).
        </p>
    </form>

    <h3 style="margin-top: 24px;">Parse Single Filing</h3>
    <form method="POST" action="/config/parse-sa">
        <div class="form-row">
            <input type="number" name="filing_id" placeholder="Filing ID" required
                style="width: 180px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
            <button type="submit">Parse Schedule A</button>
        </div>
        <p class="muted" style="font-size: 0.85em; margin-top: 8px;">
            Manually parse Schedule A items from any F3X filing (must already be ingested).
        </p>
    </form>
</div>

<h2>Last Cron Run</h2>
<div class="config-section">
    {% if last_cron_run %}
    <div class="cron-status {{ last_cron_run.status }}">
        <div class="cron-header">
            <span>
                {% if last_cron_run.source == 'cloud_run_job' %}
                <strong>Cloud Run Job</strong>
                {% else %}
                <strong>HTTP {{ last_cron_run.http_status }}</strong>
                {% endif %}
                &mdash; {{ last_cron_run.started_at[:19] | replace('T', ' ') }} UTC
            </span>
            <span class="cron-badge {{ last_cron_run.status }}">{{ last_cron_run.status | upper }}</span>
        </div>
        <dl class="cron-details">
            {% if last_cron_run.iterations is defined and last_cron_run.iterations %}
            <dt>Iterations</dt>
            <dd>{{ last_cron_run.iterations }}</dd>
            {% endif %}
            <dt>Data Found</dt>
            <dd>
                F3X: {{ last_cron_run.f3x_new }} new
                {% if last_cron_run.f3x_failed %}<span style="color: #dc3545;">, {{ last_cron_run.f3x_failed }} failed</span>{% endif %}
                {% if last_cron_run.f3x_error %}<span style="color: #dc3545;"> (error)</span>{% endif %}
                &bull;
                IE Events: {{ last_cron_run.ie_events_new }} new
                {% if last_cron_run.ie_error %}<span style="color: #dc3545;"> (error)</span>{% endif %}
                &bull;
                SA: {{ last_cron_run.sa_filings|default(0) }} filings, {{ last_cron_run.sa_events|default(0) }} events
            </dd>

            <dt>Email</dt>
            <dd>
                {% if last_cron_run.email_sent %}
                    Sent to: {{ last_cron_run.emails_sent_to | join(', ') }}
                {% else %}
                    No email sent (no new data or no recipients)
                {% endif %}
            </dd>

            {% if last_cron_run.completed_at %}
            <dt>Duration</dt>
            <dd>Completed at {{ last_cron_run.completed_at[:19] | replace('T', ' ') }} UTC</dd>
            {% endif %}
        </dl>

        {% if last_cron_run.f3x_error %}
        <div class="cron-error">F3X Error: {{ last_cron_run.f3x_error }}</div>
        {% endif %}
        {% if last_cron_run.ie_error %}
        <div class="cron-error">IE Error: {{ last_cron_run.ie_error }}</div>
        {% endif %}
        {% if last_cron_run.crash_error %}
        <div class="cron-error">Crash: {{ last_cron_run.crash_error }}</div>
        {% endif %}
    </div>
    {% else %}
    <p class="muted">No cron runs recorded yet.</p>
    {% endif %}
</div>

<h2>Backfill Historical Data</h2>
<div class="config-section">
    <form method="POST" action="" id="backfill-form">
        <div class="form-row">
            <input type="date" name="date" id="backfill-date" required style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
            <select name="type" id="backfill-type" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="3x">F3X</option>
                <option value="e">Schedule E</option>
            </select>
            <button type="submit">Start Backfill</button>
        </div>
    </form>
    <script>
        document.getElementById('backfill-form').addEventListener('submit', function(e) {
            var date = document.getElementById('backfill-date').value;
            var type = document.getElementById('backfill-type').value;
            if (date) {
                var parts = date.split('-');
                this.action = '/config/backfill/' + parts[0] + '/' + parseInt(parts[1]) + '/' + parseInt(parts[2]) + '/' + type;
            }
        });
    </script>

    <h3>Active Jobs</h3>
    {% if backfill_jobs %}
    {% for job in backfill_jobs %}
    <div class="job-row">
        <span class="job-info">
            <strong>{{ job.target_date }}</strong> ({{ job.filing_type }})
            {% if job.error_message %}<br><small>{{ job.error_message }}</small>{% endif %}
        </span>
        <span class="job-status {{ job.status }}">{{ job.status }}</span>
        <form method="POST" action="/config/backfill/{{ job.id }}/delete" style="margin: 0;">
            <button type="submit" class="delete-btn">Delete</button>
        </form>
    </div>
    {% endfor %}
    {% else %}
    <p class="muted">No pending or running backfill jobs.</p>
    {% endif %}
</div>

<h2>Email Recipients</h2>
<div class="config-section">
    <form method="POST" action="/config/recipients">
        <div class="form-row">
            <input type="email" name="email" placeholder="email@example.com" required />
            <button type="submit">Add Recipient</button>
        </div>
        <div class="form-row">
            <input type="text" name="committee_ids" placeholder="Committee IDs (comma-separated, blank = all)" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
        </div>
    </form>

    <h3>Current Recipients</h3>
    {% if recipients %}
    {% for r in recipients %}
    <div class="recipient-row" style="flex-wrap: wrap;">
        <span class="recipient-email">{{ r.email }}</span>
        <span class="recipient-status {{ 'active' if r.active else 'inactive' }}">
            {{ 'Active' if r.active else 'Inactive' }}
        </span>
        <form method="POST" action="/config/recipients/{{ r.id }}/delete" style="margin: 0;">
            <button type="submit" class="delete-btn">Remove</button>
        </form>
        <form method="POST" action="/config/recipients/{{ r.id }}/committees" style="margin: 0; display: flex; gap: 8px; width: 100%; margin-top: 4px;">
            <input type="text" name="committee_ids" value="{{ r.committee_ids | join(', ') if r.committee_ids else '' }}" placeholder="All committees" style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85em;" />
            <button type="submit" style="padding: 6px 12px; background: #0366d6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">Save Filter</button>
        </form>
    </div>
    {% endfor %}
    {% else %}
    <p class="muted">No email recipients configured.</p>
    {% endif %}
</div>
{% endblock %}
